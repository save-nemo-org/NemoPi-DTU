# NemoPi-DTU

NemoPi data transfer unit firmware of AIR780X CAT-1 Modem

## Development environment

Hardware: Hezhou AIR780XX CAT-1 Modem based on EC618 silicon

Host operating system: Win10, Win11

Firmware flashing tool: [Luatools_v2](https://luatos.com/luatools/download/last)

> Note: AIR780 uses a Microsoft defined COM PORT driver which availables in Windows 10.
> This driver only seems to work on native Window 10 machine.
> All COM PORTS can be recognised in Virtual Machine (VirtualBox), but the firmware flashing tool (Luatools_v2) cannot establish connection with the hardware in bootloader mode.

## Development resource

- LuatOS API manual: https://wiki.luatos.org/api/index.html
- LuatOS source code and examples: https://gitee.com/openLuat/LuatOS
- Firmware over the air update (Chinese): https://doc.openluat.com/wiki/40?wiki_page_id=4632

## API

### SMS API

Due to the cost of outbound SMS and challenges in handling international mobile number, most of the SMS commands will not respond over SMS.

PING command is designed to return OK over SMS for functionality checking. Please use this API with care.

| COMMAND     | ARGUMENT | RETURN | NOTE                                                                                               |
| ----------- | -------- | ------ | -------------------------------------------------------------------------------------------------- |
| PING        | N/A      | OK     |                                                                                                    |
| REBOOT      | N/A      | N/A    |                                                                                                    |
| CREDENTIALS | URL      | N/A    | URL has to start with http:// or https://                                                          |
| OTA         | URL      | N/A    | URL has to start with http:// or https://, firmware has to be generated by luatools in .bin format |

### MQTT API

|              |                     |
| ------------ | ------------------- |
| client_id    | \<IMEI>             |
| publish to   | buoys/\<IMEI>/d2c/# |
| subscribe to | buoys/\<IMEI>/c2d/# |

### D2C MQTT Telemetry

#### Logon package on mqtt connect

- endpoint: `buoys/\<IMEI>/d2c/telemetry`
- msg_type: connection
- schema:
  ```json
  {
    "msg_type": "connect",
    "firmware": str,
    "ticks": int,
    "imei": str,
    "power_on_reason": [int, int, int],
    "version": "x.x.x"
  }
  ```

#### Sensor detection (once every boot up)

- endpoint: `buoys/\<IMEI>/d2c/telemetry`
- msg_type: detect
- schema:
  ```json
  {
    "msg_type": "detect",
    "sensors": [
      {
        "model": "DS18B20-LOGGER",
        "feature": { "ch2": true, "ch1": false },
        "address": 2,
        "interface": "rs485"
      }
    ]
  }
  ```

#### Sensor reading

- endpoint: `buoys/\<IMEI>/d2c/telemetry`
- msg_type: data
- schema:
  ```json
  {
    "msg_type": "data",
    "sensors": [
      {
        "model": "DS18B20-LOGGER",
        "interface": "rs485",
        "address": 2,
        "data": [
          {
            "channel": "ch1",
            "value": 1.234, // float or null
            "fault": "string (empty string when no fault detected)"
          },
          {
            "channel": "ch2",
            "value": null, // float or null
            "fault": "string (empty string when no fault detected)"
          }
        ]
      }
    ]
  }
  ```

#### Diagnosis info

- endpoint: `buoys/\<IMEI>/d2c/telemetry`
- msg_type: diagnosis
- schema:
  ```json
  {
    "msg_type": "diagnosis",
    "lat_lon": {
      "lon": float,
      "lat": float
    },
    "vbat": float,
    "cell": [<Tower Info Dict>, <Tower Info Dict>, ...]
  }
  ```

### C2D MQTT Commands

#### Cloud to device command:

- endpoint: `buoys/<IMEI>/c2d/cmd`
- msg_type: "cmd"
- schema:

  ```json
  {
    "msg_type": "cmd",
    "cmd": "<string>",
    "operation_id": "<string>", # when available
    "some_attribute": "some_attribute_value", # when available
  }
  ```

#### Device to cloud response:

- endpoint: `buoys/<IMEI>/d2c/response`
- msg_type: "response"
- schema:
  - On success:
    ```json
    {
      "msg_type": "response",
      "cmd": "<string>",
      "operation_id": "<string>", # when available
      "status": "ok"
    }
    ```
  - On failure:
    ```json
    {
      "msg_type": "response",
      "cmd": "<string>",          # when available
      "operation_id": "<string>", # when available
      "reason": "<string>",
      "status": "failed"
    }
    ```

#### Supported commands:

| cmd    | attributes      | Expected behaviour                                                                                       |
| ------ | --------------- | -------------------------------------------------------------------------------------------------------- |
| ping   |                 |                                                                                                          |
| ota    | `url: <string>` | Device will download firmware from the given url. Cloud end need to issue reboot after a successful OTA. |
| reboot |                 | Device will reboot in 60 seconds                                                                         |

#### Legacy commands:

> Legacy shall NOT be used in new applications. Support of certain command will be removed over the future releases.

| cmd    | attributes                              | Expected behaviour                                                                                                        |
| ------ | --------------------------------------- | ------------------------------------------------------------------------------------------------------------------------- |
| config | `"config": {"read_interval_ms": float}` | Device will update `read_interval_ms` in non-volatile storage. Cloud end need to issue reboot after configuration update. |

## Simulatior

A PC based simulator is available at https://github.com/openLuat/luatos-soc-pc, LuatOS main repo (https://github.com/openLuat/luatos) need to be placed in same folder of luatos-soc-pc.

Pre-compiled simulator binary:

```powershell
.\tools\bin\luatos-pc.exe .\platforms\PC\ .\src\
```
